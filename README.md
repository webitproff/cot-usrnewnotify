# Плагин User New Notify для Cotonti Siena

![License](https://img.shields.io/badge/license-BSD-blue.svg)
[![Version](https://img.shields.io/badge/version-2.2.0-green.svg)](https://github.com/webitproff/usrnewnotify/releases)
[![Cotonti Compatibility](https://img.shields.io/badge/Cotonti_Siena-0.9.26-orange.svg)](https://www.cotonti.com/)
[![PHP](https://img.shields.io/badge/PHP-8.4-blueviolet.svg)](https://www.php.net/releases/8_4_0.php)
[![MySQL](https://img.shields.io/badge/MySQL-8.0-blue.svg)](https://www.mysql.com/)

**User New Notify** — это плагин для CMF Cotonti Siena, который отправляет администратору уведомления о регистрации новых пользователей по электронной почте, а также предоставляет интерфейс в админ-панели для просмотра логов регистраций с фильтрацией и поиском. Плагин поддерживает текстовый и HTML-формат уведомлений, логирование в базу данных и отображение подробной информации о пользователе, включая устройство, браузер и страну.

## Основные возможности
- Отправка уведомлений администратору(ам) по email при регистрации нового пользователя.
- Поддержка текстового и HTML-формата уведомлений с красивым форматированием (таблицы, стили).
- Включение в уведомления детальной информации: имя пользователя, email, дата регистрации, IP-адрес, страница регистрации, устройство, браузер, страна и ссылка на профиль.
- Логирование всех регистраций в базу данных с возможностью просмотра в админ-панели.
- Фильтрация и поиск логов по имени пользователя, email, IP, стране, статусу и дате регистрации.
- Поддержка нескольких email-адресов для уведомлений (через запятую).
- Настраиваемые параметры через админ-панель Cotonti.
- Многоязычная поддержка (русский, английский, украинский).
- Интерфейс админ-панели с таблицей логов, пагинацией и фильтрацией.

## Требования
- **CMF Cotonti Siena**: версия 0.9.26 или выше.
- **PHP**: 8.4 или выше.
- **MySQL**: 8.0 или выше.
- **Права доступа**: 
  - Гости: чтение (R).
  - Пользователи: чтение/запись (RW).
  - Блокировка: 12345A для гостей и членов.
- **Внешний API**: Для определения страны по IP используется [ip-api.com](http://ip-api.com) (бесплатно, до 45 запросов/мин).

## Установка
1. Скачайте последнюю версию плагина из [репозитория GitHub](https://github.com/webitproff/cot-usrnewnotify).
2. Распакуйте архив в папку `plugins/` вашего сайта на Cotonti.
3. Перейдите в админ-панель Cotonti: **Администрирование → Расширения → Установить плагин**.
4. Найдите плагин `User New Notify` и нажмите **Установить**.
5. Плагин автоматически создаст таблицу `cot_usrnewnotify_logs` в базе данных.

## Настройка
После установки плагин можно настроить в админ-панели Cotonti: **Администрирование → Расширения → User New Notify → Настройки**.

### Доступные параметры:
- **Включить уведомления (`notify_enabled`)**: Включение или отключение отправки email-уведомлений (0 — отключено, 1 — включено).
- **Email-адреса для уведомлений (`notify_email`)**: Укажите один или несколько email-адресов администраторов через запятую (например, `admin1@example.com,admin2@example.com`).
- **Формат уведомлений (`notify_format`)**: Выберите `text` для текстового формата или `html` для форматированного HTML-уведомления.
- **Логирование в базу данных (`notify_log`)**: Включение или отключение записи логов регистраций в базу данных (0 — отключено, 1 — включено).

## Использование
1. **Уведомления**:
   - При регистрации нового пользователя плагин отправляет email-уведомление на указанные адреса.
   - Уведомление содержит: имя пользователя, email, дату регистрации, страницу регистрации, IP-адрес, страну, устройство, браузер и ссылку на профиль пользователя.
   - HTML-уведомления отображаются в виде таблицы с современным дизайном.

2. **Просмотр логов**:
   - Перейдите в админ-панель: **Администрирование → Расширения → User New Notify**.
   - Вы увидите таблицу с логами регистраций, включающую:
     - ID записи.
     - Имя пользователя.
     - Email.
     - IP-адрес.
     - Страна.
     - Устройство (Mobile, Tablet, Desktop).
     - Браузер (Chrome, Firefox, Safari и т.д.).
     - Дата регистрации.
     - Статус отправки уведомления (Успешно/Ошибка).
     - Сообщение об ошибке (если есть).
     - Ссылка на профиль пользователя.
   - Поддерживается фильтрация по имени, email, IP, стране, статусу и диапазону дат.
   - Таблица включает пагинацию для удобного просмотра.

## Файлы плагина
| Файл | Описание |
|------|----------|
| `usrnewnotify.setup.php` | Регистрирует метаданные и конфигурацию плагина. |
| `usrnewnotify.php` | Основная логика отправки уведомлений и логирования. |
| `usrnewnotify.tools.php` | Интерфейс админ-панели для просмотра и фильтрации логов. |
| `usrnewnotify.tools.tpl` | Шаблон для интерфейса админ-панели. |
| `inc/usrnewnotify.functions.php` | Функции для определения устройства, браузера, страны и логирования. |
| `lang/usrnewnotify.ru.lang.php` | Русская локализация. |
| `lang/usrnewnotify.en.lang.php` | Английская локализация. |
| `lang/usrnewnotify.ua.lang.php` | Украинская локализация. |
| `usrnewnotify.install.sql` | SQL-скрипт для создания таблицы `cot_usrnewnotify_logs`. |
| `usrnewnotify.uninstall.sql` | SQL-скрипт для удаления таблицы при деинсталляции. |

## Структура базы данных
Таблица `cot_usrnewnotify_logs` содержит следующие поля:
- `log_id` (INT, PRIMARY KEY): Уникальный идентификатор записи.
- `log_user_id` (INT): ID пользователя.
- `log_user_name` (VARCHAR): Имя пользователя.
- `log_user_email` (VARCHAR): Email пользователя.
- `log_ip` (VARCHAR): IP-адрес пользователя (поддерживает IPv4/IPv6).
- `log_user_agent` (TEXT): Полный User-Agent.
- `log_device` (VARCHAR): Тип устройства (Mobile, Tablet, Desktop).
- `log_browser` (VARCHAR): Название браузера.
- `log_country` (VARCHAR): Страна пользователя.
- `log_date` (DATETIME): Дата регистрации.
- `log_status` (ENUM): Статус отправки уведомления (success/error).
- `log_message` (TEXT): Сообщение об ошибке или успехе.

## Безопасность
- Все пользовательские данные экранируются с помощью `htmlspecialchars` для предотвращения XSS-атак.
- IP-адреса валидируются с помощью `filter_var`.
- Email-адреса проверяются перед отправкой уведомлений.
- SQL-запросы используют подготовленные выражения для предотвращения SQL-инъекций.
- Внешний API для определения страны (ip-api.com) используется безопасно с обработкой ошибок.

## Лицензия
Плагин распространяется под лицензией BSD. Подробности см. в файле `usrnewnotify.setup.php`.

## Автор
- **webitproff**
- GitHub: [https://github.com/webitproff](https://github.com/webitproff)
- Copyright © 2025 webitproff

## Вклад
Если вы хотите внести улучшения в плагин, создайте Pull Request на [GitHub](https://github.com/webitproff/cot-usrnewnotify). Приветствуются любые идеи, включая:
- Добавление поддержки вебхуков (Telegram, Discord).
- Расширение фильтров в админ-панели (например, по устройству или браузеру).
- Добавление тестового уведомления через админ-панель.

## Известные проблемы
- Для корректной работы HTML-уведомлений почтовый клиент администратора должен поддерживать HTML.
- Определение устройства, браузера и страны зависит от User-Agent и внешнего API, что может быть неточным в некоторых случаях.
- API ip-api.com имеет ограничение в 45 запросов в минуту (бесплатная версия).

## Поддержка
Если у вас есть вопросы или проблемы с плагином, создайте Issue на [GitHub](https://github.com/webitproff/cot-usrnewnotify/issues).
